{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog","author":"Kyle Mathews"}},"markdownRemark":{"id":"da8c2fcc-369d-5eb5-a818-3675adbad129","html":"<hr>\n<p>title: gitlab与 gitlab runner 安装问题\ndate: Wed Jun 27 2018 18:29:48 GMT+0800 (CST)\nupdated: Wed Jun 27 2018 21:21:47 GMT+0800 (CST)\ncomments: 1\ncategories:\ntags: [[object Object],[object Object]]\npermalink:  gitlab-gitlab-runner-install</p>\n<hr>\n<h2>环境</h2>\n<ul>\n<li>阿里云 ECS（2核4G）</li>\n<li>CentOS 7.x</li>\n<li>Mac</li>\n</ul>\n<!--more-->\n<h2>问题</h2>\n<h3>问题1</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\">\n      <pre class=\"language-text\"><code class=\"language-text\">Preparing services... Starting services... /opt/gitlab/embedded/bin/runsvdir-start: line 24: ulimit: pending signals: cannot modify limit: Operation not permitted</code></pre>\n      </div>\n<p><img src=\"https://images-manager.oss-cn-shanghai.aliyuncs.com/2018/gitlab/1.png\"></p>\n<h3>解决方案</h3>\n<p>并不是给那些提示的文件描述权限，而是给以下目录权限</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\">\n      <pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> 2770 /srv/gitlab/data/git-data/repositories</code></pre>\n      </div>\n<p>参考链接</p>\n<p><a href=\"https://mp.weixin.qq.com/s?__biz=MzI1MTA0OTM0Mw==&#x26;mid=2650959269&#x26;idx=1&#x26;sn=9200a125a392ab758e5eda70cb06f697&#x26;chksm=f20e29b5c579a0a3e6dc7f45e4e6687ad2711df9625ba5d0bedfa5f462730c822e716618600e&#x26;mpshare=1&#x26;scene=1&#x26;srcid=08179qwIdJzHhlvrkJRbWonQ&#x26;key=3ca3acd7b7e79486ba072b984547bfaa48440387c4a04b42aceb4989f2dfd1e14e5b06a7cb48de54a8593d5f366c554f4396c09ac920fbeaf7df045569c0ea6eaa6395c0839b0902833a950a6a2f9725&#x26;ascene=0&#x26;uin=MjE4MTczNDcwMA%3D%3D&#x26;devicetype=iMac+MacBookAir6%2C1+OSX+OSX+10.12.5+build(16F73)&#x26;version=12020\">https://mp.weixin.qq.com/s?__biz=MzI1MTA0OTM0Mw==&#x26;mid=2650959269&#x26;idx=1&#x26;sn=9200a125a392ab758e5eda70cb06f697&#x26;chksm=f20e29b5c579a0a3e6dc7f45e4e6687ad2711df9625ba5d0bedfa5f462730c822e716618600e&#x26;mpshare=1&#x26;scene=1&#x26;srcid=08179qwIdJzHhlvrkJRbWonQ&#x26;key=3ca3acd7b7e79486ba072b984547bfaa48440387c4a04b42aceb4989f2dfd1e14e5b06a7cb48de54a8593d5f366c554f4396c09ac920fbeaf7df045569c0ea6eaa6395c0839b0902833a950a6a2f9725&#x26;ascene=0&#x26;uin=MjE4MTczNDcwMA%3D%3D&#x26;devicetype=iMac+MacBookAir6%2C1+OSX+OSX+10.12.5+build(16F73)&#x26;version=12020</a></p>\n<h3>问题 2</h3>\n<p>gitlab runner 独立于 gitlab，安装 gitlab 后需要在 docker 再起一个 contaienr，并且注册时若选择了 spec token 需要再项目里设置。</p>\n<p><code class=\"language-text\">gitlab runner install</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\">\n      <pre class=\"language-bash\"><code class=\"language-bash\">docker run -d --name gitlab-runner --restart always \\\n  -v /srv/gitlab-runner/config:/etc/gitlab-runner \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  gitlab/gitlab-runner:latest</code></pre>\n      </div>\n<p><img src=\"https://images-manager.oss-cn-shanghai.aliyuncs.com/2018/gitlab/2.png\"></p>\n<h3>解决方案</h3>\n<p><code class=\"language-text\">gitlab runner register</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\">\n      <pre class=\"language-text\"><code class=\"language-text\">docker exex -it gitlab gitlab register</code></pre>\n      </div>\n<p><img src=\"https://images-manager.oss-cn-shanghai.aliyuncs.com/2018/gitlab/3.png\"></p>\n<h3>问题 3</h3>\n<p>gitlab 配置好runner之后发现CI还是pedding， 一个是指定runner，一个是共享runner，指定runner需要在项目里面配置，共享runner需要指定tag</p>\n<p><img src=\"https://images-manager.oss-cn-shanghai.aliyuncs.com/2018/gitlab/4.png\"></p>\n<h3>解决方案</h3>\n<p>启用untag的runner</p>\n<p><img src=\"https://images-manager.oss-cn-shanghai.aliyuncs.com/2018/gitlab/5.png\"></p>\n<p>顺利构建</p>\n<p><img src=\"https://images-manager.oss-cn-shanghai.aliyuncs.com/2018/gitlab/6.png\"></p>\n<h3>问题4</h3>\n<p>`gitlab docker in docker `<code class=\"language-text\"></code></p>\n<p>如下错误</p>\n<div class=\"gatsby-highlight\" data-language=\"text\">\n      <pre class=\"language-text\"><code class=\"language-text\">Warning: failed to get default registry endpoint from daemon (Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?). Using system default: https://index.docker.io/v1/\nNot logged in to https://index.docker.io/v1/</code></pre>\n      </div>\n<p><img src=\"https://images-manager.oss-cn-shanghai.aliyuncs.com/2018/gitlab/7.png\"></p>\n<h3>解决方案</h3>\n<p>增加sock磁盘目录</p>\n<div class=\"gatsby-highlight\" data-language=\"text\">\n      <pre class=\"language-text\"><code class=\"language-text\">vi /srv/gitlab-runner/config/config.toml\ndocker restart [imageid]\n\nconcurrent = 1\ncheck_interval = 0\n\n[[runners]]\n  name = &quot;#####&quot;\n  url = &quot;#####&quot;\n  token = &quot;#####&quot;\n  executor = &quot;docker&quot;\n  [runners.docker]\n    tls_verify = false\n    image = &quot;docker:latest&quot;\n    privileged = false\n    disable_cache = false\n    cache_dir = &quot;cache&quot;\n    volumes = [&quot;/var/run/docker.sock:/var/run/docker.sock&quot;, &quot;/cache&quot;]\n  [runners.cache]\n    Insecure = false</code></pre>\n      </div>\n<p>参考链接： <a href=\"https://gitlab.com/gitlab-org/gitlab-runner/issues/1986\">https://gitlab.com/gitlab-org/gitlab-runner/issues/1986</a></p>","frontmatter":{"title":"","date":null}}},"pageContext":{"slug":"/2018-06-27-gitlab与 gitlab runner 安装问题/","previous":{"fields":{"slug":"/react-demo/"},"frontmatter":{"title":"React Demo"}},"next":{"fields":{"slug":"/2018-02-08-webpack 处理 css module的一种方式/"},"frontmatter":{"title":""}}}}